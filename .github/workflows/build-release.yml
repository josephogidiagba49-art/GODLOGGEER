name: ğŸ”¥ GodKeyLogger Build & Release

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

env:
  BUILD_CONFIG: 'Release'
  EXE_NAME: 'GodKeyLogger.exe'

jobs:
  build-windows:
    name: ğŸªŸ Build Windows Executable
    runs-on: windows-latest
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Setup MSVC with Windows SDK
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: x64
        uwp: false
        spectre: true
        
    - name: ğŸ” Show MSVC Information
      shell: cmd
      run: |
        cl.exe
        where cl.exe
        where link.exe
        
    - name: ğŸ—ï¸ Build with MSBuild (Method 1 - Recommended)
      shell: cmd
      run: |
        echo ====================================
        echo   BUILDING GOD KEYLOGGER v2.0
        echo   Using MSBuild
        echo ====================================
        
        msbuild GodKeyLogger.csproj /p:Configuration=Release /p:Platform=x64 /p:WindowsTargetPlatformVersion=10.0
        
    - name: ğŸ—ï¸ Alternative Build with CL.EXE (Method 2)
      if: failure()  # Only run if MSBuild fails
      shell: cmd
      run: |
        echo ====================================
        echo   BUILDING GOD KEYLOGGER v2.0
        echo   Using CL.EXE Directly
        echo ====================================
        
        "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Tools\MSVC\14.38.33130\bin\Hostx64\x64\cl.exe" ^
          /nologo ^
          /EHsc ^
          /Ox ^
          /W2 ^
          /DUNICODE ^
          /D_UNICODE ^
          /MT ^
          /std:c++17 ^
          /Fe:GodKeyLogger.exe ^
          GodKeyLogger.cpp ^
          user32.lib gdi32.lib advapi32.lib winhttp.lib crypt32.lib ^
          /link /SUBSYSTEM:WINDOWS /MACHINE:x64
        
        if %errorlevel% neq 0 exit 1
        
    - name: ğŸ—ï¸ Fallback Build with MSVC (Method 3)
      if: failure()  # Only run if previous methods fail
      shell: cmd
      run: |
        echo ====================================
        echo   BUILDING GOD KEYLOGGER v2.0
        echo   Using Fallback Method
        echo ====================================
        
        set VSDIR=C:\Program Files\Microsoft Visual Studio\2022\Enterprise
        set MSVCDIR=%VSDIR%\VC\Tools\MSVC
        set TOOLVER=
        
        for /d %%i in ("%MSVCDIR%\*") do set TOOLVER=%%~nxi
        
        echo Tool Version: %TOOLVER%
        
        set PATH=%MSVCDIR%\%TOOLVER%\bin\Hostx64\x64;%PATH%
        
        cl.exe /? >nul 2>&1
        
        if %errorlevel% equ 0 (
            cl.exe /EHsc /Ox /W2 /DUNICODE /D_UNICODE /MT /std:c++17 ^
            GodKeyLogger.cpp ^
            /link /SUBSYSTEM:WINDOWS /OUT:GodKeyLogger.exe ^
            user32.lib gdi32.lib advapi32.lib winhttp.lib crypt32.lib
        ) else (
            echo "âŒ CL.EXE not found!"
            exit 1
        )
        
    - name: âœ… Verify Build
      shell: cmd
      run: |
        echo ====================================
        echo   VERIFYING BUILD
        echo ====================================
        
        if not exist GodKeyLogger.exe (
            echo "âŒ BUILD FAILED: Executable not found!"
            dir *.exe
            exit 1
        )
        
        # Get file information
        for %%F in (GodKeyLogger.exe) do (
            echo "âœ… BUILD SUCCESSFUL"
            echo "ğŸ“ File: %%~nxF"
            echo "ğŸ“¦ Size: %%~zF bytes"
            echo "ğŸ“… Modified: %%~tF"
        )
        
        # Test if it's a valid PE file
        dumpbin /headers GodKeyLogger.exe >nul 2>&1
        if %errorlevel% equ 0 (
            echo "ğŸ” Valid Windows PE executable"
        )
        
    - name: ğŸ”’ Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: GodKeyLogger-Windows-Executable
        path: GodKeyLogger.exe
        retention-days: 30
        
    - name: ğŸ·ï¸ Create GitHub Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        name: GodKeyLogger ${{ github.ref_name }}
        draft: false
        prerelease: false
        generate_release_notes: true
        files: GodKeyLogger.exe
        
    - name: ğŸ“¤ Manual Release Upload
      if: github.event_name == 'workflow_dispatch'
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: manual-${{ github.run_number }}
        name: Manual Build #${{ github.run_number }}
        draft: true
        files: GodKeyLogger.exe
