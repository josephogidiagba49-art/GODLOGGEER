name: Build Power Angel v8.0

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup MSVC
      uses: microsoft/setup-msbuild@v1
    
    - name: Build executable
      run: |
        echo "Building Power Angel v8.0..."
        echo "=========================================="
        
        # Create a simple batch file to set up environment and compile
        @echo off
        setlocal enabledelayedexpansion
        
        echo [INFO] Setting up MSVC environment...
        
        :: Get the Visual Studio installation path
        set "VSWHERE=C:\Program Files (x86)\Microsoft Visual Studio\Installer\vswhere.exe"
        set "VSINSTALLDIR="
        for /f "usebackq tokens=*" %%i in (`"!VSWHERE!" -latest -property installationPath`) do (
          set "VSINSTALLDIR=%%i"
        )
        
        if "!VSINSTALLDIR!"=="" (
          echo [ERROR] Visual Studio not found
          exit /b 1
        )
        
        :: Set up environment variables
        set "VCVARS=!VSINSTALLDIR!\VC\Auxiliary\Build\vcvars64.bat"
        if exist "!VCVARS!" (
          call "!VCVARS!"
        ) else (
          echo [ERROR] vcvars64.bat not found
          exit /b 1
        )
        
        :: Compile the code
        echo [INFO] Compiling PowerAngel.cpp...
        cl /O2 /MT /DUNICODE /D_UNICODE /EHsc ^
          /I "C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\shared" ^
          /I "C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\um" ^
          /I "C:\Program Files (x86)\Windows Kits\10\Include\10.0.22621.0\ucrt" ^
          AngelSmartMichael.cpp ^
          /link ^
          shell32.lib ^
          winhttp.lib ^
          gdiplus.lib ^
          ole32.lib ^
          oleaut32.lib ^
          comctl32.lib ^
          user32.lib ^
          kernel32.lib ^
          advapi32.lib ^
          /SUBSYSTEM:WINDOWS ^
          /ENTRY:wWinMainCRTStartup ^
          /OUT:PowerAngel_v8.exe
        
        if errorlevel 1 (
          echo [ERROR] Compilation failed
          exit /b 1
        )
        
        if exist PowerAngel_v8.exe (
          echo [SUCCESS] Build completed successfully!
          echo File size: 
          dir PowerAngel_v8.exe
        ) else (
          echo [ERROR] Executable not created
          exit /b 1
        )
        
        endlocal
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: PowerAngel-v8.0
        path: PowerAngel_v8.exe
        retention-days: 7
