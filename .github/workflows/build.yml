name: ðŸ—ï¸ Build GodKeyLogger

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ”§ Setup MSVC Environment
      shell: cmd
      run: |
        echo ====================================
        echo   SETTING UP VISUAL STUDIO 2022
        echo ====================================
        
        :: Find and setup Visual Studio
        set VSPATH="C:\Program Files\Microsoft Visual Studio\2022\Enterprise"
        
        if exist "%VSPATH%\VC\Auxiliary\Build\vcvars64.bat" (
            echo Found Visual Studio 2022 at: %VSPATH%
            call "%VSPATH%\VC\Auxiliary\Build\vcvars64.bat"
            echo âœ… Visual Studio environment setup complete
        ) else (
            echo âŒ Visual Studio not found, trying 2022 Build Tools...
            set VSPATH="C:\Program Files (x86)\Microsoft Visual Studio\2022\BuildTools"
            if exist "%VSPATH%\VC\Auxiliary\Build\vcvars64.bat" (
                call "%VSPATH%\VC\Auxiliary\Build\vcvars64.bat"
                echo âœ… Build Tools environment setup complete
            ) else (
                echo âŒ ERROR: No Visual Studio found!
                echo Available Visual Studio installations:
                dir "C:\Program Files\Microsoft Visual Studio\"
                dir "C:\Program Files (x86)\Microsoft Visual Studio\"
                exit 1
            )
        )
        
        :: Verify cl.exe is available
        where cl.exe
        echo.
        
    - name: ðŸ—ï¸ Build Executable (Method 1 - Direct Path)
      shell: cmd
      run: |
        echo ====================================
        echo   BUILDING GOD KEYLOGGER v3.0
        echo ====================================
        
        :: Method 1: Direct path to cl.exe (Guaranteed to work)
        set CLPATH="C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Tools\MSVC\14.38.33130\bin\Hostx64\x64\cl.exe"
        
        if exist %CLPATH% (
            echo âœ… Using cl.exe from: %CLPATH%
            %CLPATH% /nologo /EHsc /Ox /W2 /std:c++17 ^
              /DUNICODE /D_UNICODE /MT ^
              GodKeyLogger.cpp ^
              /link /SUBSYSTEM:WINDOWS ^
              /OUT:GodKeyLogger.exe ^
              user32.lib gdi32.lib advapi32.lib winhttp.lib crypt32.lib
        ) else (
            echo âŒ cl.exe not found at specific path, trying alternative...
            
            :: Method 2: Search for cl.exe
            where /R "C:\Program Files\Microsoft Visual Studio\" cl.exe > cl_location.txt 2>nul
            where /R "C:\Program Files (x86)\Microsoft Visual Studio\" cl.exe >> cl_location.txt 2>nul
            
            set /p CLPATH=<cl_location.txt
            if "%CLPATH%"=="" (
                echo âŒ ERROR: cl.exe not found anywhere!
                echo Trying manual compilation...
                
                :: Method 3: Manual compilation with vcvars
                call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\Common7\Tools\VsDevCmd.bat" -arch=x64
                cl.exe /nologo /EHsc /O2 GodKeyLogger.cpp ^
                  /link /SUBSYSTEM:WINDOWS /OUT:GodKeyLogger.exe ^
                  user32.lib gdi32.lib advapi32.lib winhttp.lib
            ) else (
                echo âœ… Found cl.exe at: %CLPATH%
                %CLPATH% /nologo /EHsc /Ox /W2 /std:c++17 ^
                  /DUNICODE /D_UNICODE /MT ^
                  GodKeyLogger.cpp ^
                  /link /SUBSYSTEM:WINDOWS ^
                  /OUT:GodKeyLogger.exe ^
                  user32.lib gdi32.lib advapi32.lib winhttp.lib crypt32.lib
            )
        )
        
        if %errorlevel% neq 0 (
            echo âš ï¸ Build failed with first method, trying fallback...
            
            :: Final fallback: Simple build without C++17
            cl.exe /nologo /EHsc /O2 /DUNICODE /D_UNICODE /MT ^
              GodKeyLogger.cpp ^
              /link /SUBSYSTEM:WINDOWS /OUT:GodKeyLogger.exe ^
              user32.lib gdi32.lib advapi32.lib winhttp.lib crypt32.lib
        )
        
    - name: âœ… Verify Build
      shell: cmd
      run: |
        if exist GodKeyLogger.exe (
            echo ====================================
            echo   âœ… BUILD SUCCESSFUL!
            echo ====================================
            echo ðŸ“ File: GodKeyLogger.exe
            
            for %%F in (GodKeyLogger.exe) do (
                echo ðŸ“¦ Size: %%~zF bytes
                echo ðŸ“… Created: %%~tF
            )
            
            :: Quick validation
            dumpbin.exe /headers GodKeyLogger.exe | findstr "subsystem" && (
                echo ðŸ” Valid Windows PE executable
            )
        ) else (
            echo ====================================
            echo   âŒ BUILD FAILED!
            echo ====================================
            echo Checking for any output files...
            dir *.exe
            dir *.obj
            exit 1
        )
        
    - name: ðŸ“¤ Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: GodKeyLogger-Executable
        path: GodKeyLogger.exe
        retention-days: 30
