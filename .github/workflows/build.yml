name: üèóÔ∏è Build GodKeyLogger

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
      
    - name: üîß Setup Visual Studio 2022
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '6.0.x'
        
    - name: üèóÔ∏è Build using MSBuild
      shell: powershell
      run: |
        Write-Host "=========================================" -ForegroundColor Green
        Write-Host "   Building GodKeyLogger v2.0" -ForegroundColor Green
        Write-Host "=========================================" -ForegroundColor Green
        
        # Method 1: Direct compile with full path to cl.exe
        $clPath = "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Tools\MSVC\14.38.33130\bin\Hostx64\x64\cl.exe"
        $linkPath = "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Tools\MSVC\14.38.33130\bin\Hostx64\x64\link.exe"
        
        if (Test-Path $clPath) {
            Write-Host "‚úÖ Found cl.exe at: $clPath" -ForegroundColor Cyan
            
            & $clPath /nologo /EHsc /Ox /W2 /std:c++17 `
              /DUNICODE /D_UNICODE /MT `
              GodKeyLogger.cpp `
              /link /SUBSYSTEM:WINDOWS `
              /OUT:GodKeyLogger.exe `
              user32.lib gdi32.lib advapi32.lib winhttp.lib crypt32.lib
              
            if ($LASTEXITCODE -eq 0) {
                Write-Host "‚úÖ Compilation successful!" -ForegroundColor Green
            } else {
                Write-Host "‚ùå Compilation failed!" -ForegroundColor Red
                exit 1
            }
        } else {
            Write-Host "‚ùå cl.exe not found!" -ForegroundColor Red
            Write-Host "Trying alternative location..." -ForegroundColor Yellow
            
            # Alternative: Use Developer Command Prompt
            $vcvars = "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars64.bat"
            if (Test-Path $vcvars) {
                cmd /c "`"$vcvars`" && cl.exe /nologo /EHsc /Ox GodKeyLogger.cpp /link /SUBSYSTEM:WINDOWS /OUT:GodKeyLogger.exe user32.lib gdi32.lib advapi32.lib winhttp.lib"
            } else {
                Write-Host "‚ùå Could not find Visual Studio tools" -ForegroundColor Red
                exit 1
            }
        }
        
    - name: ‚úÖ Verify build
      shell: powershell
      run: |
        if (Test-Path "GodKeyLogger.exe") {
            $file = Get-Item "GodKeyLogger.exe"
            Write-Host "‚úÖ BUILD SUCCESSFUL!" -ForegroundColor Green
            Write-Host "üìÅ File: $($file.Name)" -ForegroundColor Cyan
            Write-Host "üì¶ Size: $($file.Length) bytes" -ForegroundColor Cyan
            Write-Host "üìç Path: $($file.FullName)" -ForegroundColor Cyan
        } else {
            Write-Host "‚ùå BUILD FAILED: Executable not created!" -ForegroundColor Red
            Get-ChildItem -Filter *.exe
            exit 1
        }
        
    - name: üì§ Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: GodKeyLogger
        path: GodKeyLogger.exe
